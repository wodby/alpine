#!/usr/bin/env bash

set -e

if [[ -n "${DEBUG}" ]]; then
    set -x
fi

signature="${1}"
file="${2}"
keyfile="${3}"

export GNUPGHOME="$(mktemp -d)"

if [[ -f "${keyfile}" ]]; then
  echo "Importing keys from ${keyfile}"
  gpg --import "${keyfile}"
else
  found=""
  declare -a keyservers=(
    "hkp://keyserver.ubuntu.com:80"
    "keyserver.ubuntu.com"
    "pgp.mit.edu"
  )

  IFS=';' read -ra keys <<< "${GPG_KEYS}"

  for key in "${keys[@]}"; do
    for server in "${keyservers[@]}"; do
      echo "Fetching GPG key ${key} from ${server}"
      gpg --keyserver "$server" --keyserver-options timeout=10 --recv-keys "${key}" && found="yes" && break 2  || echo "Trying new server..."
    done
  done

  if [[ -z "${found}" ]]; then
    echo >&2 "error: failed to fetch GPG key ${GPG_KEYS}"
    exit 1
  fi
fi

gpg --batch --verify "${signature}" "${file}"
gpgconf --kill all || :
rm -rf "${GNUPGHOME}" "${signature}"